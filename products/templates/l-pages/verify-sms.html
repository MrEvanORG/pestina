{% extends 'l-pages/patterns/base.html' %}
{% block title %}تایید شماره تلفن{% endblock title %}
{% block content %}
    <div class="container">
        <div class="card verification-card">
            <h2>تأیید شماره تلفن</h2>
            <p class="verification-text">کد پیامک‌ شده به شماره تلفن <strong>{{number}}</strong> را وارد کنید.</p>
            <a href="{% url 'sign-up' %}" class="login-link" style="margin-top: 0px;">شماره اشتباه است ؟</a>

            <form method="POST">
                {% csrf_token %}

                <div class="input-group input-code">
                    <label for="code">: کد تأیید</label>
                    <input type="text" id="code" name="code" maxlength="6" required
                    style="
                        color:var(--dark-color);
                        width: 94%;
                        padding: 8px;
                        border: 1px solid var(--border-color);
                        border-radius: 100px;">
                    {% if form.code.errors %}
                        <div class="error"><p style="font-weight:bold;">{{ form.code.errors }}</p></div>
                    {% endif %}
                    <p id="otp-message" style="color:var(--secondary-color); font-weight:bold;"></p>
                </div>
                <div class="button-container" style="flex-direction:column;align-items:center;">
                    <button id="resend-btn" class="btn" type="button" disabled>
                        تلاش مجدد تا <span id="timer">{{ retry_seconds }}</span> ثانیه دیگر
                    </button>
                    <button type="submit" class="btn" style="width:85%;margin-top:10px;">ادامه</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}
{% block script %}
<script>
    let timer = {{ retry_seconds|default:0 }};
    let btn = document.getElementById('resend-btn');
    let timerEl = document.getElementById('timer');
    let msgBox = document.getElementById('otp-message');

    function startCountdown() {
        btn.disabled = true;
        timerEl.textContent = timer;
        let interval = setInterval(() => {
            timer--;
            if (timer > 0) {
                timerEl.textContent = timer;
            } else {
                clearInterval(interval);
                btn.disabled = false;
                btn.textContent = "ارسال مجدد کد";
            }
        }, 1000);
    }

    btn.addEventListener('click', function () {
        btn.disabled = true;
        btn.textContent = "در حال ارسال...";
        fetch("{% url 'send-otp' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `phone={{ number }}`
        })
        .then(res => res.json())
        .then(data => {
            msgBox.textContent = data.message;
            if (data.status === 200) {
                btn.innerHTML = 'تلاش مجدد تا <span id="timer">90</span> ثانیه دیگر';
                timerEl = document.getElementById('timer');
                timer = 90;
                startCountdown();
            } else {
                btn.disabled = false;
                btn.textContent = "ارسال مجدد کد";
            }
        })
        .catch(err => {
            msgBox.textContent = "خطا در ارتباط با سرور";
            btn.disabled = false;
            btn.textContent = "ارسال مجدد کد";
        });
    });

    if (timer > 0) {
        startCountdown();
    } else {
        btn.disabled = false;
        btn.textContent = "ارسال کد";
    }
</script>
{% endblock %}